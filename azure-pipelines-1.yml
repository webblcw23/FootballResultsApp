# Pipeline to test our SonarCloud
trigger: none

pool:
  vmImage: "ubuntu-latest"

stages:
- stage: SonarCloud
  displayName: SonarCloud Test
  jobs:
  - job: BuildWithSonarCloud
    displayName: Build .NET Project With SonarCloud
    steps:
    - checkout: self
      fetchDepth: 0

    - task: SonarCloudPrepare@4
      inputs:
        SonarCloud: 'sonarcloud-connection-ado'   # name of your service connection
        organization: 'webblcw23'
        scannerMode: 'dotnet'                    # use MSBuild for .NET projects
        projectKey: 'webblcw23_FootballScores'
        projectName: 'FootballScores'
        extraProperties: |
          # Only analyze your C# source files
          sonar.inclusions=**/*.cs

          # Exclude build artifacts, generated code, tests, and libraries
          sonar.exclusions=**/bin/**,**/obj/**,**/Migrations/**,**/wwwroot/**,**/lib/**,**/node_modules/**,**/dist/**,**/coverage/**,**/*.Designer.cs,**/*.generated.cs,**/*.js,**/*.css,**/*.html,**/*.xml
          sonar.test.exclusions=**/*Tests.csproj,**/Tests/**

          # Point SonarCloud to coverage reports
          sonar.cs.opencover.reportsPaths=**/TestResults/**/coverage.cobertura.xml

    - script: dotnet build Rangers.Web.csproj
      displayName: 'Build .NET project'

    # Run unit tests and collect coverage
    - script: dotnet test Rangers.Web.csproj --collect:"XPlat Code Coverage"
      displayName: 'Run unit tests with coverage'

    # Publish test results to Azure DevOps (optional, but nice for visibility)
    - task: PublishTestResults@2
      inputs:
        testResultsFiles: '**/TestResults/*.trx'
        testRunTitle: 'Unit Tests'

    - task: SonarCloudAnalyze@4
      displayName: 'Run SonarCloud analysis'

    - task: SonarCloudPublish@4
      inputs:
        pollingTimeoutSec: '300'
      displayName: 'Publish SonarCloud results'